version: '3.8'

services:
  auth-server:
    build:
      context: .
      dockerfile: auth-server/Dockerfile
    container_name: iam-dk-auth-server
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://directory-db:5432/iamdk_directory
      - SPRING_DATASOURCE_USERNAME=iamdk
      - SPRING_DATASOURCE_PASSWORD=secret
    depends_on:
      - directory-db
    ports:
      - "127.0.0.1:8080:8080"

  directory-service:
    build:
      context: .
      dockerfile: directory-service/Dockerfile
    container_name: iam-dk-directory-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://directory-db:5432/iamdk_directory
      - SPRING_DATASOURCE_USERNAME=iamdk
      - SPRING_DATASOURCE_PASSWORD=secret
    depends_on:
      - directory-db
    ports:
      - "127.0.0.1:8081:8081"

  admin-console:
    build:
      context: .
      dockerfile: admin-console/Dockerfile
    container_name: iam-dk-admin-console
    environment:
      - REACT_APP_API_URL=http://directory-service:8081/api/admin
    ports:
      - "127.0.0.1:80:80"
    extra_hosts:
      - "directory-service:127.0.0.1"

  sample-resource-server:
    build:
      context: .
      dockerfile: sample-resource-server/Dockerfile
    container_name: iam-dk-sample-resource-server
    environment:
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUE_TOKEN_URL=http://auth-server:8080/oauth2/introspect
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_ISSUER_URI=http://auth-server:8080
    depends_on:
      - auth-server
    ports:
      - "127.0.0.1:8082:8082"

  directory-db:
    image: postgres:15-alpine
    container_name: iam-dk-directory-db
    environment:
      - POSTGRES_USER=iamdk
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=iamdk_directory
    ports:
      - "127.0.0.1:5432:5432"
