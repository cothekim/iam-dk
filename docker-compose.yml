version: '3.8'

services:
  auth-server:
    build:
      context: .
      dockerfile: auth-server/Dockerfile
    container_name: iam-dk-auth-server
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://directory-db:5432/iamdk_directory
      - SPRING_DATASOURCE_USERNAME=iamdk
      - SPRING_DATASOURCE_PASSWORD=secret
    depends_on:
      - directory-db
    ports:
      - "8080:8080"

  directory-service:
    build:
      context: .
      dockerfile: directory-service/Dockerfile
    container_name: iam-dk-directory-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://directory-db:5432/iamdk_directory
      - SPRING_DATASOURCE_USERNAME=iamdk
      - SPRING_DATASOURCE_PASSWORD=secret
    depends_on:
      - directory-db
    ports:
      - "8081:8081"

  admin-console:
    build:
      context: .
      dockerfile: admin-console/Dockerfile
      args:
        # 호스트 IP를 환경변수로 받거나, 기본값으로 host.docker.internal 사용
        # 사용 예: REACT_APP_API_URL=http://192.168.1.100:8081/api/admin docker-compose build
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://host.docker.internal:8081/api/admin}
    container_name: iam-dk-admin-console
    ports:
      - "80:80"

  sample-resource-server:
    build:
      context: .
      dockerfile: sample-resource-server/Dockerfile
    container_name: iam-dk-sample-resource-server
    environment:
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUE_TOKEN_URL=http://auth-server:8080/oauth2/introspect
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_ISSUER_URI=http://auth-server:8080
    depends_on:
      - auth-server
    ports:
      - "8082:8082"

  directory-db:
    image: postgres:15-alpine
    container_name: iam-dk-directory-db
    environment:
      - POSTGRES_USER=iamdk
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=iamdk_directory
    ports:
      - "5432:5432"
